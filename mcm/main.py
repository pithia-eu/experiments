import os
import shutil
import io
import numpy
import pandas
import zipfile
import matplotlib.pyplot as plt
import seaborn as sns
from random import randint
from pydantic import BaseModel, Field
from fastapi import FastAPI, Query
from fastapi.responses import StreamingResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

description = """
description required 

## Functionalities:
* Execute the model.
* Plot results.
* Download results.
"""

tags_metadata = [
    {
        "name": "execute",
        "description": "Initiate a model execution by specifying the following parameters:<br>"
                       "fm: Mean F10.7 flux of last 81 day, ge=60, le=250<br>"
                       "fl: Daily F10.7 flux of previous day, ge=60, le=300<br>"
                       "atl: Altitude, ge=120, le=1500<br>"
                       "lat: Latitude, ge=?, le=?<br>"
                       "long: Longitude, ge=?, le=?<br>"
                       "day: Day of the year, ge=1, le=366<br>"
                       "akp1: Geomagnetic activity index kp delayed by 3 hours, ge=0, le=9<br>"
                       "akp3: Mean geomagnetic activity index kp of the last 24 hours, ge=0, le=9<br>",
    },
    {
        "name": "plots",
        "description": "Create a plot of the selected file by passing an execution id.<br>"
                       "The plot can be downloaded, and presents data from 0-24 per 1hr, for latitude in range, +87 to -87, per 3 degrees.",
    },
    {
        "name": "files",
        "description": "Download an output file by passing an execution id."
    },
    {
        "name": "results",
        "description": "Download all results (e.g. plots and figures) by passing an execution id.<br>"
                       "Rename the file and add .zip as an extension.",
    },
]

app = FastAPI(title='MCM',
              description=description,
              version="1.0",
              openapi_tags=tags_metadata
              )

origins = ["*"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


class Model(BaseModel):
    fm: int = Field(default=180, title="Mean F10.7 flux of last 81 day", ge=60,
                    le=250)  # Mean F10.7 flux of last 81 day
    fl: int = Field(default=100, title="Daily F10.7 flux of previous day", ge=60,
                    le=300)  # Daily F10.7 flux of previous day
    alt: int = Field(default=300, title="Altitude", ge=120, le=1500)  # Altitude
    lat: int = Field(default=300, title="Altitude", ge=120, le=1500)  # Latitude
    long: int = Field(default=300, title="Altitude", ge=120, le=1500)  # v
    day: int = Field(default=180, title="Day of the year", ge=1, le=366)  # Day of year
    akp1: int = Field(default=0, title="Geomagnetic activity index kp delayed by 3 hours", ge=0,
                      le=9)  # Geomagnetic activity index kp
    akp3: int = Field(default=0, title="Mean geomagnetic activity index kp of the last 24 hours", ge=0,
                      le=9)  # Geomagnetic activity index kp


model = Model()


@app.get("/execute", tags=["execute"])
async def execute(fm: int = model.fm,
                  fl: int = model.fl,
                  alt: int = model.alt,
                  lat: int = model.lat,
                  long: int = model.long,
                  day: int = model.day,
                  akp1: int = model.akp1,
                  akp3: int = model.akp3):
    try:
        Model(fm=fm, fl=fl, alt=alt, lat=lat, long=long, day=day, akp1=akp1, akp3=akp3)
    except Exception as e:
        r = e.__str__().replace('\n', ' ')
        r = r.replace('Model', 'parameter:')
        return r

    os.chdir('/home/ubuntu/experiments/mcm/runs')
    folder_created = False
    while not folder_created:
        id_ = randint(1000000000, 9999999999)
        try:
            os.mkdir(f'{str(id_)}')
            print(f'folder {id_} created')
            folder_created = True
        except Exception as e:
            print(e)
            print(f'folder {id_} exist')


    shutil.copy(f'../modMCM_All_PITHIA.exe', f'{id_}/modMCM_All_PITHIA.exe')
    shutil.copytree(f'../data', f'{id_}/data')

    os.chdir(f'{id_}')
    input_file_string = f'{fm},{fl},{alt},{lat},{long},{day},{akp1},{akp3}'
    f = open("input", "a")
    f.write(input_file_string)
    f.close()

    f = open(f"{id_}-inputs.txt", "a")
    f.write(input_file_string)
    f.close()

    command_string = f'./modMCM_All_PITHIA.exe < input'
    print(command_string)
    print(f'input: {input_file_string}')
    os.system('./modMCM_All_PITHIA.exe < input')

    results = []
    files = os.listdir()
    for file in files:
        if file.endswith('.datx'):
            results.append(file)

    return {'execution_id': id_}, \
        {'parameters': {'fm': fm, 'fl': fl, 'alt': alt, 'lat': lat, 'long': long, 'day': day, 'akp1': akp1, 'akp3': akp3}}, \
        {'result_files': results}


@app.get("/plots", tags=["plots"],
         responses={
             200: {
                 "content": {"image/png": {}},
                 "description": "Return the Plot as an image/png.",
             }
         },
         response_class=FileResponse)
async def plot_results(execution_id: int,
                       data: str = Query(enum=['He',
                                               'N2',
                                               'O',
                                               'ro',
                                               'Tinf',
                                               'Tz'])):
    try:
        os.chdir(f'/home/ubuntu/experiments/mcm/runs/{execution_id}')
        latidute = []
        counter = 0
        for i in reversed(range(-87, 88)):
            if counter == 3:
                latidute.append(i)
                counter = 0
            elif counter == 0:
                latidute.append(i)
            counter += 1

        df = pandas.read_csv(f'DTM20F107Kp_{data}.datx', sep='     ', header=None, engine='python')
        lat_array = numpy.array(latidute)

        df = df.iloc[::-1]
        df = df.set_index(keys=lat_array)

        fig = plt.figure(figsize=[8, 8])
        ax = sns.heatmap(df, linewidth=0, cmap='Spectral_r')
        plt.ylabel('latitude')
        plt.xlabel('solar local time')
        plt.title(f'DTM20F107Kp_{data}.data')
        fig.savefig(f'DTM20F107Kp_{data}.png')
        # return FileResponse(f'DTM20F107Kp_{data}.png', media_type="image/png")
        response = FileResponse(f'DTM20F107Kp_{data}.png', media_type="image/png")
        response.headers["Content-Disposition"] = f"attachment; filename=DTM20F107Kp_{execution_id}_{data}.png"
        print(response.headers)
        return response

    except Exception as e:
        return e.__str__


@app.get("/files", tags=["files"],
         responses={
             200: {
                 "content": {"media/csv": {}},
                 "description": "Return the file as a media/csv.",
             }
         },
         response_class=FileResponse)
async def download_results_files(execution_id: int,
                                 data: str = Query(enum=['He',
                                                         'N2',
                                                         'O',
                                                         'ro',
                                                         'Tinf',
                                                         'Tz'])):
    try:
        os.chdir(f'/home/ubuntu/experiments/mcm/runs/{execution_id}')
        response = FileResponse(f'DTM20F107Kp_{data}.datx', media_type="text/csv")
        response.headers["Content-Disposition"] = f"attachment; filename=DTM20F107Kp_{execution_id}_{data}.csv"
        print(response.headers)
        return response
    except Exception as e:
        return e.__str__


@app.get("/results", tags=["results"],
         responses={
             200: {
                 "content": {"application/octet-stream": {}},
                 "description": "Return a zip will all Plots and Files as an application/zip.",
             }
         },
         response_class=FileResponse)
async def download_all_results(execution_id: int):
    try:
        os.chdir(f'/home/ubuntu/experiments/mcm/runs/{execution_id}')
        zip_temp_path = f'/home/ubuntu/experiments/mcm/runs/{execution_id}/DTM20F107Kp_{execution_id}.zip'
        if os.path.exists(zip_temp_path):
            zip_file_path = zip_temp_path
        else:
            latidute = []
            counter = 0
            for i in reversed(range(-87, 88)):
                if counter == 3:
                    latidute.append(i)
                    counter = 0
                elif counter == 0:
                    latidute.append(i)
                counter += 1
            enum = ['He',
                    'N2',
                    'O',
                    'ro',
                    'Tinf',
                    'Tz']
            for data in enum:
                df = pandas.read_csv(f'DTM20F107Kp_{data}.datx', sep='     ', header=None, engine='python')
                lat_array = numpy.array(latidute)

                df = df.iloc[::-1]
                df = df.set_index(keys=lat_array)

                fig = plt.figure(figsize=[8, 8])
                ax = sns.heatmap(df, linewidth=0, cmap='Spectral_r')
                plt.ylabel('latitude')
                plt.xlabel('solar local time')
                plt.title(f'DTM20F107Kp_{data}.data')
                fig.savefig(f'DTM20F107Kp_{data}.png')

            # io_ = io.BytesIO()
            zip_file_path = zip_temp_path
            zip_file = zipfile.ZipFile(zip_file_path, "w")

            files = os.listdir()
            files_to_zip = [f"{execution_id}-inputs.txt"]
            for file in files:
                if file.endswith('.datx') or file.endswith('.png'):
                    files_to_zip.append(file)
            # with zipfile.ZipFile(io_, mode='w') as zip:
            for file in files_to_zip:
                zip_file.write(file)
            zip_file.close()

        response = FileResponse(zip_file_path, media_type="application/octet-stream")
        response.headers["Content-Disposition"] = f"attachment; filename=DTM20F107Kp_{execution_id}.zip"
        return response

    except Exception as e:
        return e.__str__